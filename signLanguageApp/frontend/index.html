<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sign Language Translator</title>
<style>
    * {margin:0;padding:0;box-sizing:border-box;}
    body {font-family:'Segoe UI',sans-serif; background:#e0e0e0; padding:20px;}
    .container {max-width:1000px;margin:0 auto;}
    .header {text-align:center;color:#333;margin-bottom:20px;}
    .header h1{font-size:2em;margin-bottom:5px;}
    .header p{font-size:1em;opacity:0.8;}
    .main-card {background:#fff;border-radius:10px;padding:20px;box-shadow:0 4px 10px rgba(0,0,0,0.1);margin-bottom:20px;}
    .language-selector {display:flex;justify-content:center;gap:10px;margin-bottom:20px;}
    .language-btn {padding:10px 25px;font-size:1em;border:1px solid #333;background:#fff;color:#333;border-radius:20px;cursor:pointer;transition:0.3s;}
    .language-btn.active {background:#333;color:#fff;}
    .gesture-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:20px;}
    .gesture-card {background:#f2f2f2;padding:15px;border-radius:10px;cursor:pointer;text-align:center;border:2px solid transparent;transition:0.2s;}
    .gesture-card:hover{border-color:#333;}
    .gesture-card.selected{background:#333;color:#fff;border-color:#555;}
    .gesture-name{font-weight:bold;margin-bottom:5px;}
    .translation-output {background:#d1d1d1;padding:20px;border-radius:10px;margin-bottom:20px;min-height:100px;text-align:center;}
    .output-text{font-size:1.5em;font-weight:bold;margin-bottom:5px;}
    .confidence{font-size:0.9em;color:#555;}
    .controls{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
    .btn{padding:10px 20px;font-size:0.95em;border:none;border-radius:20px;cursor:pointer;font-weight:bold;transition:0.3s;}
    .btn-translate{background:#333;color:white;}
    .btn-speak{background:#555;color:white;}
    .btn-clear{background:#999;color:white;}
    .btn:disabled{opacity:0.5;cursor:not-allowed;}
    .history-section{background:#fff;border-radius:10px;padding:15px;box-shadow:0 4px 10px rgba(0,0,0,0.1);}
    .history-title{font-size:1.2em;margin-bottom:10px;text-align:center;color:#333;}
    .history-list{max-height:200px;overflow-y:auto;}
    .history-item{background:#f2f2f2;padding:10px;border-radius:5px;margin-bottom:5px;}
    .history-text{font-weight:bold;}
    .history-meta{font-size:0.8em;color:#555;}
    #videoContainer {display:flex;justify-content:center;margin-bottom:20px;}
    video, canvas {border:2px solid #333;border-radius:10px;}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Sign Language Translator</h1>
        <p>Convert ASL & ISL to Text and Speech</p>
    </div>

    <div class="main-card">
        <div class="language-selector">
            <button class="language-btn active" id="aslBtn" onclick="selectLanguage('ASL')">ASL</button>
            <button class="language-btn" id="islBtn" onclick="selectLanguage('ISL')">ISL</button>
        </div>

        <div id="videoContainer">
            <video id="video" width="400" height="300" autoplay muted></video>
            <canvas id="canvas" width="400" height="300" style="display:none;"></canvas>
        </div>

        <div class="translation-output">
            <div class="output-text" id="outputText">Select a gesture</div>
            <div class="confidence" id="confidence"></div>
        </div>

        <div class="controls">
            <button class="btn btn-translate" onclick="translateGesture()" id="translateBtn" disabled>Translate</button>
            <button class="btn btn-speak" onclick="speakText()" id="speakBtn" disabled>Speak</button>
            <button class="btn btn-clear" onclick="clearSelection()">Clear</button>
            <button class="btn" onclick="startCamera()">Start Camera</button>
            <button class="btn" onclick="stopCamera()">Stop Camera</button>
        </div>
    </div>

    <div class="history-section">
        <h2 class="history-title">Translation History</h2>
        <div class="history-list" id="historyList">
            <p style="text-align:center; color:#999;">No translations yet</p>
        </div>
    </div>
</div>

<script src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
<script>
    const API_BASE_URL = 'http://localhost:8080/api';
    let currentLanguage = 'ASL';
    let selectedGesture = null;
    let currentTranslation = '';
    let gestures = [];
    let history = [];

    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    let streaming = false;
    let src = null, dst = null;

    window.onload = loadGestures;

    function selectLanguage(lang) {
        currentLanguage = lang;
        document.getElementById('aslBtn').classList.remove('active');
        document.getElementById('islBtn').classList.remove('active');
        if(lang==='ASL') document.getElementById('aslBtn').classList.add('active');
        else document.getElementById('islBtn').classList.add('active');
        loadGestures();
        clearSelection();
    }

    async function loadGestures() {
        try {
            const res = await fetch(`${API_BASE_URL}/gestures/${currentLanguage}`);
            gestures = await res.json();
            renderGestures();
        } catch(err){
            console.error(err);
            document.getElementById('gestureGrid').innerHTML = '<p style="text-align:center; color:#999;">Error loading gestures. Make sure backend is running.</p>';
        }
    }

    function renderGestures(){
        const grid = document.getElementById('gestureGrid');
        grid.innerHTML = '';
        gestures.forEach(g=>{
            const card=document.createElement('div');
            card.className='gesture-card';
            card.innerHTML=`<div class="gesture-name">${g.gestureName.replace(/_/g,' ')}</div>
                            <div class="gesture-translation">${g.textTranslation}</div>`;
            card.onclick=()=>selectGesture(g,card);
            grid.appendChild(card);
        });
    }

    function selectGesture(gesture, card){
        document.querySelectorAll('.gesture-card').forEach(c=>c.classList.remove('selected'));
        card.classList.add('selected');
        selectedGesture = gesture;
        document.getElementById('translateBtn').disabled = false;
        document.getElementById('outputText').textContent = 'Click Translate';
        document.getElementById('confidence').textContent = '';
        document.getElementById('speakBtn').disabled = true;
    }

    function translateGesture(){
        if(!selectedGesture) return;
        const confidence = (85 + Math.random()*15).toFixed(1);
        currentTranslation = selectedGesture.textTranslation;
        document.getElementById('outputText').textContent = currentTranslation;
        document.getElementById('confidence').textContent = `Confidence: ${confidence}%`;
        document.getElementById('speakBtn').disabled = false;
        addToHistory(selectedGesture.gestureName, currentTranslation, confidence);
    }

    function speakText(){
        if(!currentTranslation) return;
        if('speechSynthesis' in window){
            const utter = new SpeechSynthesisUtterance(currentTranslation);
            window.speechSynthesis.speak(utter);
        }
    }

    function clearSelection(){
        document.querySelectorAll('.gesture-card').forEach(c=>c.classList.remove('selected'));
        selectedGesture=null;
        currentTranslation='';
        document.getElementById('outputText').textContent='Select a gesture';
        document.getElementById('confidence').textContent='';
        document.getElementById('translateBtn').disabled=true;
        document.getElementById('speakBtn').disabled=true;
    }

    function addToHistory(gesture, translation, confidence){
        const item = {gesture, translation, confidence, language:currentLanguage, timestamp:new Date().toLocaleTimeString()};
        history.unshift(item);
        if(history.length>10) history = history.slice(0,10);
        renderHistory();
    }

    function renderHistory(){
        const list = document.getElementById('historyList');
        if(history.length===0){ list.innerHTML='<p style="text-align:center; color:#999;">No translations yet</p>'; return; }
        list.innerHTML='';
        history.forEach(h=>{
            const div=document.createElement('div');
            div.className='history-item';
            div.innerHTML=`<div class="history-text">${h.translation}</div>
            <div class="history-meta">${h.language} - ${h.gesture.replace(/_/g,' ')} | Confidence: ${h.confidence}% | ${h.timestamp}</div>`;
            list.appendChild(div);
        });
    }

    // --- OpenCV.js Webcam ---
    function startCamera(){
        if(streaming) return;
        navigator.mediaDevices.getUserMedia({video:true}).then(stream=>{
            video.srcObject=stream;
            video.play();
            streaming=true;
            video.onloadedmetadata = ()=>{processVideo();}
        }).catch(err=>console.error(err));
    }

    function stopCamera(){
        if(!streaming) return;
        let tracks = video.srcObject.getTracks();
        tracks.forEach(track=>track.stop());
        streaming=false;
        if(src) { src.delete(); dst.delete(); }
    }

    async function processVideo(){
    if(!streaming) return;

    if(!src){ 
        src=new cv.Mat(video.height, video.width, cv.CV_8UC4); 
        dst=new cv.Mat(video.height, video.width, cv.CV_8UC1);
    }

    ctx.drawImage(video,0,0,video.width,video.height);
    let imageData = ctx.getImageData(0,0,video.width,video.height);
    src.data.set(imageData.data);

    // Convert to grayscale
    cv.cvtColor(src,dst,cv.COLOR_RGBA2GRAY);
    // Apply Gaussian blur
    cv.GaussianBlur(dst, dst, new cv.Size(5,5), 0);
    // Thresholding to get binary image
    cv.threshold(dst, dst, 100, 255, cv.THRESH_BINARY_INV+cv.THRESH_OTSU);

    // Find contours
    let contours = new cv.MatVector();
    let hierarchy = new cv.Mat();
    cv.findContours(dst, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

    let maxArea = 0;
    let maxContour = null;

    for(let i=0;i<contours.size();i++){
        let cnt = contours.get(i);
        let area = cv.contourArea(cnt);
        if(area > maxArea){
            maxArea = area;
            maxContour = cnt;
        }
    }

    if(maxContour && maxArea > 1000){ // Only process significant contours
        let rect = cv.boundingRect(maxContour);
        // Draw rectangle for debug
        cv.rectangle(src, new cv.Point(rect.x,rect.y), new cv.Point(rect.x+rect.width, rect.y+rect.height), [0,255,0,255], 2);
        
        // Crop hand region
        let handMat = src.roi(rect);
        // Convert to canvas for sending to backend
        let handCanvas = document.createElement('canvas');
        handCanvas.width = rect.width;
        handCanvas.height = rect.height;
        let handCtx = handCanvas.getContext('2d');
        let handImageData = new ImageData(new Uint8ClampedArray(handMat.data), rect.width, rect.height);
        handCtx.putImageData(handImageData,0,0);

        // Convert to base64
        let base64Image = handCanvas.toDataURL('image/png');

        // Send to backend
        try {
            let res = await fetch(`${API_BASE_URL}/camera/recognize`, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({image: base64Image})
            });
            if(res.ok){
                let data = await res.json();
                document.getElementById('outputText').textContent = data.gesture || 'Unknown';
                document.getElementById('confidence').textContent = `Confidence: ${data.confidence || 0}%`;
            }
        } catch(err){
            console.error(err);
        }
        handMat.delete();
    }

    // Show processed video
    cv.imshow('canvas', src);

    // Cleanup
    contours.delete(); hierarchy.delete();

    setTimeout(processVideo, 100); // ~10 FPS
}

</script>
</body>
</html>